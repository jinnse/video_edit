AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Root SAM Stack for Video Pipeline

Parameters:
  StepFunctionName:
    Type: String
    Description: "Step Function workflow name"
  InputBucketName:
    Type: String
    Description: "S3 ë²„í‚· ì´ë¦„" 
  OutputBucketName:
    Type: String
    Description: "S3 ì¶œë ¥ ë²„í‚· ì´ë¦„"
  EventBridgeName:
    Type: String
    Description: "EventBridge Rule ì´ë¦„"
  s3inputpath:
    Type: String
    Description: "S3 ì…ë ¥ ê²½ë¡œ"
  TranscribeName:
    Type: String
    Description: "Transcribe Lambda í•¨ìˆ˜ ì´ë¦„"
  MediaConvertName:
    Type: String
    Description: "MediaConvert Lambda í•¨ìˆ˜ ì´ë¦„"
# ê³µí†µ
  DataBucketName:        { Type: String }
  DataPrefix:            { Type: String, Default: "converted/" }  # converted/ë¡œ í†µì¼

  # Pegasus ê³µí†µ
  PegasusProfileName:    { Type: String, Default: "apac.twelvelabs.pegasus-1-2-v1:0" }
  PegasusAgentVersion:   { Type: String, Default: "DRAFT" }
  FoundationModelId:     { Type: String, Default: "anthropic.claude-3-7-sonnet-20250219-v1:0" }

  # Shorts / Transcribe ë“±ì—ì„œ ì“°ëŠ” ì…ì¶œë ¥ ë²„í‚·
  InputBucketName:       { Type: String, Default: "" }   # ì˜µì…˜ Aë¡œ ë¹„ì›Œë‘˜ ìˆ˜ ìˆê²Œ
  InputPrefix:           { Type: String, Default: "original/" }
  OutputBucketName:      { Type: String, Default: "" }   # ì˜µì…˜ Aë¡œ ë¹„ì›Œë‘˜ ìˆ˜ ìˆê²Œ

  # ìƒˆë¡œ ì¶”ê°€ (ê¶Œì¥ í”„ë¦¬í”½ìŠ¤)
  CutOutputPrefix:       { Type: String, Default: "output/" }
  ConvertPrefix:         { Type: String, Default: "converted/" }
  TranscribePrefix:      { Type: String, Default: "transcribe/" }

  # ì—ì´ì „íŠ¸ ê³µí†µ
  AgentVersion:          { Type: String, Default: "DRAFT" }
  AgentModelId:          { Type: String, Default: "anthropic.claude-3-7-sonnet-20250219-v1:0" }

  # Cut* ê³„ì—´
  VideoBucketName:       { Type: String, Default: "" }
  MediaConvertRoleArn:   { Type: String, Default: "" }
  EnableTranscribeCut: { Type: String, AllowedValues: ["true","false"], Default: "true" }

  AgentModelId:
    Type: String
    Default: ""   # ì˜¨ë””ë§¨ë“œ ëª¨ë¸ ì“¸ ë•Œë§Œ ì‚¬ìš©
  AgentInferenceProfileId:
    Type: String
    Default: ""   # í”„ë¡œíŒŒì¼ ì‚¬ìš©í•  ë•Œ ì—¬ê¸°ì— ê°’(ì˜ˆ: apac.anthropic.claude-3-5-...

  # ì˜µì…˜ A: ì•ë‹¨ ì—°ë™(ë²„í‚·/ì´ë²¤íŠ¸ ë“±) ë„ê¸°/ì¼œê¸°
  EnableIntegrations:
    Type: String
    AllowedValues: [true, false]
    Default: false

Conditions:
  UseIntegrations: !Equals [!Ref EnableIntegrations, "true"]
  DoShorts:     !Equals [ !Ref EnableShorts,     "true" ]
  DoSummary:    !Equals [ !Ref EnableSummary,    "true" ]
  DoTranscribe: !Equals [ !Ref EnableTranscribe, "true" ]
  DoCutShorts: !Equals [ !Ref EnableCutShorts, "true" ]
  DoPegasus:    !Equals [ !Ref EnablePegasus,    "true" ]
  DoCutTranscribe: !Equals [ !Ref EnableCutTranscribe, "true" ]
  UseInferenceProfile: !Not [!Equals [!Ref AgentInferenceProfileId, ""]]

Resources:
  S3EventBridgeModule:
    Type: AWS::Serverless::Application
    Properties:
      Location: ./modules/eventbridge/template.yaml
      Parameters:
        StepFunctionName: !Ref StepFunctionName
        InputBucketName: !Ref InputBucketName
        EventBridgeName: !Ref EventBridgeName
        s3inputpath: !Ref s3inputpath
    DependsOn: StepFunctionsModule

  TranscribeLambdaModule:
    Type: AWS::Serverless::Application
    Properties:
      Location: ./modules/lambdas/transcribe_lambda/template.yaml
      Parameters:
        InputBucketName: !Ref InputBucketName
        OutputBucketName: !Ref OutputBucketName
        TranscribeName: !Ref TranscribeName

  MediaConvertLambdaModule:
    Type: AWS::Serverless::Application
    Properties:
      Location: ./modules/lambdas/mediaconvert_lambda/template.yaml
      Parameters:
        InputBucketName: !Ref InputBucketName
        OutputBucketName: !Ref OutputBucketName
        MediaConvertName: !Ref MediaConvertName

  StepFunctionsModule:
    Type: AWS::Serverless::Application
    Properties:
      Location: ./modules/stepfunctions/template.yaml
      Parameters:
        transcribeName: !Ref TranscribeName
        mediaConvertName: !Ref MediaConvertName
    DependsOn:
      - MediaConvertLambdaModule
      - TranscribeLambdaModule

    # # â”€â”€ Transcribe (í•­ìƒ ìƒì„±) â”€â”€
  TranscribeActionGroup:
    Condition: DoTranscribe
    Type: AWS::Serverless::Application
    Properties:
      Location: ./modules/bedrock/transcribe/action_group/template.yaml
      Parameters:
        # OutputBucketNameì´ ë¹„ì–´ë„(ì˜µì…˜ A) ë°°í¬ëŠ” ì§„í–‰ë˜ê²Œ í•˜ë˜,
        # nested í…œí”Œë¦¿ì´ 'í•„ìˆ˜'ë¡œ ê°•ì œí•˜ë©´ ê°’ ê¼­ ë„£ì–´ì•¼ í•¨.
        OutputBucketName: !Ref OutputBucketName
  TranscribeAgent:
    Condition: DoTranscribe
    Type: AWS::Serverless::Application
    Properties:
      Location: ./modules/bedrock/transcribe/agent/template.yaml
      Parameters:
        TranscribeLambdaArn: !GetAtt TranscribeActionGroup.Outputs.TranscribeLambdaAliasArn
        AgentVersion:        !Ref AgentVersion
        AgentModelId:        !Ref AgentModelId

  # â”€â”€ Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  SummaryActionGroup:
    Condition: DoSummary
    Type: AWS::Serverless::Application
    Properties:
      Location: ./modules/bedrock/summary/action_group/template.yaml
      Parameters:
        # Action Groupì´ ìš”êµ¬í•˜ëŠ” íŒŒë¼ë¯¸í„° ì´ë¦„ì— ë§ì¶° ì „ë‹¬
        DataBucketName: !Ref OutputBucketName         
        DataPrefix:     !Ref TranscribePrefix         

  SummaryAgent:
    Condition: DoSummary
    Type: AWS::Serverless::Application
    Properties:
      Location: ./modules/bedrock/summary/agent/template.yaml
      Parameters:
        SummaryLambdaArn: !GetAtt SummaryActionGroup.Outputs.SummaryLambdaAliasArn
        AgentVersion:     !Ref AgentVersion        
        AgentModelId:     !Ref AgentModelId          

  # â”€â”€ Shorts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ShortsActionGroup1:
    Condition: DoShorts
    Type: AWS::Serverless::Application
    Properties:
      Location: ./modules/bedrock/shorts/action_group_1/template.yaml
      Parameters:
        OutputBucketName: !Ref OutputBucketName

  ShortsActionGroup2:
    Condition: DoShorts
    Type: AWS::Serverless::Application
    Properties:
      Location: ./modules/bedrock/shorts/action_group_2/template.yaml
      Parameters:
        InputBucketName:    !Ref InputBucketName
        InputPrefix:        !Ref InputPrefix
        PegasusProfileName: !Ref PegasusProfileName

  ShortsAgent:
    Condition: DoShorts
    Type: AWS::Serverless::Application
    Properties:
      Location: ./modules/bedrock/shorts/agent/template.yaml
      Parameters:
        Shorts1LambdaArn: !GetAtt ShortsActionGroup1.Outputs.Shorts1LambdaAliasArn
        Shorts2LambdaArn: !GetAtt ShortsActionGroup2.Outputs.Shorts2LambdaAliasArn
        AgentVersion:     !Ref AgentVersion
        AgentModelId:     !Ref AgentModelId

  # â”€â”€ Pegasus â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  PegasusAction:
    Condition: DoPegasus
    Type: AWS::Serverless::Application
    Properties:
      Location: ./modules/bedrock/pegasus/action_group/template.yaml
      Parameters:
        DataBucketName:     !Ref DataBucketName
        DataPrefix:         !Ref DataPrefix
        PegasusProfileName: !Ref PegasusProfileName

  PegasusAgent:
    Condition: DoPegasus
    Type: AWS::Serverless::Application
    Properties:
      Location: ./modules/bedrock/pegasus/agent/template.yaml
      Parameters:
        # ğŸ”§ ì›ë³¸ ì˜¤íƒ€ ìˆ˜ì •: PegasusActionGroup â†’ PegasusAction
        PegasusLambdaArn:  !GetAtt PegasusAction.Outputs.PegasusLambdaAliasArn
        AgentVersion:      !Ref PegasusAgentVersion
        FoundationModelId: !Ref FoundationModelId

  # â”€â”€ Cut Shorts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  CutShortsActionGroup:
    Condition: DoCutShorts
    Type: AWS::Serverless::Application
    Properties:
      Location: ./modules/bedrock/cut_shorts/action_group/template.yaml
      Parameters:
        VideoBucketName:     !Ref VideoBucketName
        MediaConvertRoleArn: !Ref MediaConvertRoleArn

  CutShortsAgent:
    Condition: DoCutShorts
    Type: AWS::Serverless::Application
    Properties:
      Location: ./modules/bedrock/cut_shorts/agent/template.yaml
      Parameters:
        CutShortsLambdaArn: !GetAtt CutShortsActionGroup.Outputs.CutShortsLambdaAliasArn
        AgentVersion:       !Ref AgentVersion
        AgentModelId:       !Ref AgentModelId

  # â”€â”€ Cut Transcribe â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  CutTranscribeActionGroup:
    Condition: DoCutTranscribe
    Type: AWS::Serverless::Application
    Properties:
      Location: ./modules/bedrock/cut_transcribe/action_group/template.yaml
      Parameters:
        VideoBucketName:     !Ref VideoBucketName
        MediaConvertRoleArn: !Ref MediaConvertRoleArn

  CutTranscribeAgent:
    Condition: DoCutTranscribe
    Type: AWS::Serverless::Application
    Properties:
      Location: ./modules/bedrock/cut_transcribe/agent/template.yaml
      Parameters:
        CutTranscribeLambdaArn: !GetAtt CutTranscribeActionGroup.Outputs.CutTranscribeLambdaAliasArn
        AgentVersion:           !Ref AgentVersion
        AgentModelId:           !Ref AgentModelId

